import { computed } from 'vue';
import { usePageData, usePageFrontmatter, usePageLang } from 'vuepress/client';
import { gitOptions } from '../options.js';
import { resolveRepoLink } from '../utils/index.js';
const RE_ISSUE = /#(\d+)/g;
export const useChangelog = () => {
    const frontmatter = usePageFrontmatter();
    const lang = usePageLang();
    const page = usePageData();
    const { pattern = {}, provider } = gitOptions;
    const repo = resolveRepoLink(gitOptions.repo, provider);
    return computed(() => {
        if (frontmatter.value.changelog === false)
            return [];
        const formatter = new Intl.DateTimeFormat(lang.value, {
            dateStyle: 'short',
        });
        // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition
        return (page.value.git?.changelog ?? []).map((item) => {
            const res = {
                date: formatter.format(item.time),
                ...item,
            };
            if (pattern.issue && repo) {
                res.message = res.message.replace(RE_ISSUE, (matched, issue) => {
                    const url = pattern
                        .issue.replace(':issue', issue)
                        .replace(':repo', repo);
                    return `<a href="${url}" target="_blank" rel="noopener noreferrer">${matched}</a>`;
                });
            }
            if (pattern.commit && repo) {
                res.commitUrl = pattern.commit
                    .replace(':hash', res.hash)
                    .replace(':repo', repo);
            }
            if (pattern.tag && repo && res.tag)
                res.tagUrl = pattern.tag.replace(':tag', res.tag).replace(':repo', repo);
            return res;
        });
    });
};
